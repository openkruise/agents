package permissions

import (
	"context"
	"os/user"

	"connectrpc.com/authn"
)

const DefaultUser = "user"
const DefaultHomeDir = "/home/user"
const DefaultUid = "1050"

func AuthenticateUsername(_ context.Context, req authn.Request) (any, error) {
	username, _, ok := req.BasicAuth()
	if !ok {
		//return nil, nil
		username = DefaultUser
	}

	u, err := GetUser(username)
	if err != nil {
		return nil, authn.Errorf("invalid username: '%s'", username)
	}

	return u, nil
}

func GetAuthUser(ctx context.Context) (*user.User, error) {
	u, ok := authn.GetInfo(ctx).(*user.User)
	if !ok {
		//return nil, connect.NewError(connect.CodeUnauthenticated, fmt.Errorf("no user specified"))
		// Set default user if none is specified
		u = &user.User{
			Username: DefaultUser,
			Name:     DefaultUser,
			HomeDir:  DefaultHomeDir,
			Uid:      DefaultUid,
			Gid:      DefaultUid,
		}
	}
	return u, nil
}